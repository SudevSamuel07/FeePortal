<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emmanuel School of Theology - Fee Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-autotable plugin for creating tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light grey background */
        }
        /* Simple transition for tab content */
        .tab-content {
            display: none;
            transition: opacity 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        /* Custom spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div id="main-content" class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Emmanuel School of Theology</h1>
            <p class="text-md text-gray-600 mt-1">Student Fee Management Portal</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="home-tab" type="button" role="tab" aria-controls="home" aria-selected="true">Add New Record</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg" id="history-tab" type="button" role="tab" aria-controls="history" aria-selected="false">Payment History</button>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Home Tab: Form for new entry -->
            <div id="home" class="tab-content active" role="tabpanel" aria-labelledby="home-tab">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-md">
                    <form id="feeForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Student Name -->
                            <div>
                                <label for="studentName" class="block mb-2 text-sm font-medium text-gray-700">Student Name</label>
                                <input type="text" id="studentName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="e.g., John Doe" required>
                            </div>
                            <!-- Batch -->
                            <div>
                                <label for="batch" class="block mb-2 text-sm font-medium text-gray-700">Batch</label>
                                <input type="text" id="batch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="e.g., 2024-2025" required>
                            </div>
                            <!-- Amount Paid -->
                            <div>
                                <label for="amountPaid" class="block mb-2 text-sm font-medium text-gray-700">Amount Paid ($)</label>
                                <input type="number" id="amountPaid" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="e.g., 500" required>
                            </div>
                            <!-- Amount Due -->
                            <div>
                                <label for="amountDue" class="block mb-2 text-sm font-medium text-gray-700">Amount Due ($)</label>
                                <input type="number" id="amountDue" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="e.g., 100" required>
                            </div>
                        </div>
                        <!-- Submit Button -->
                        <div class="mt-8 text-right">
                            <button type="submit" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-6 py-3 text-center transition-colors">Save & Generate PDF</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- History Tab: Table of previous entries -->
            <div id="history" class="tab-content" role="tabpanel" aria-labelledby="history-tab">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Payment History</h2>
                    <div id="loader-container" class="flex justify-center items-center h-48">
                        <div class="loader"></div>
                    </div>
                    <div id="history-table-container" class="overflow-x-auto hidden">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Student Name</th>
                                    <th scope="col" class="px-6 py-3">Batch</th>
                                    <th scope="col" class="px-6 py-3">Paid</th>
                                    <th scope="col" class="px-6 py-3">Due</th>
                                    <th scope="col" class="px-6 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-records" class="text-center text-gray-500 py-8 hidden">No records found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="alertTitle">Success!</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="alertMessage">Record saved successfully.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeAlertModal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Are you sure?</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Do you really want to delete this record? This process cannot be undone.</p>
                </div>
                <div class="flex justify-center items-center px-4 py-3 gap-x-4">
                    <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Delete
                    </button>
                    <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBSHQwYgd_GUkcaK-l7Mk9kLLqG4pgB-j8",
            authDomain: "student-fee-tracker-391e3.firebaseapp.com",
            projectId: "student-fee-tracker-391e3",
            storageBucket: "student-fee-tracker-391e3.appspot.com",
            messagingSenderId: "581276005356",
            appId: "1:581276005356:web:dd4b4e36839a94a45106c9",
            measurementId: "G-E2GXB35315"
        };
        
        // --- Main Application Logic ---
        function startApp() {
            // --- Configuration Check ---
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md" role="alert">
                        <h2 class="font-bold text-xl mb-2">Configuration Required</h2>
                        <p class="mb-4">
                            To connect to the database, you need to add your personal Firebase configuration keys to the code.
                        </p>
                        <p>
                            Please follow the instructions in the code comments to create a free Firebase project and paste your unique <code>firebaseConfig</code> keys into the script section of this HTML file.
                        </p>
                    </div>
                `;
                return;
            }

            // If config is valid, proceed with initialization
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // --- Authentication ---
            async function authenticate() {
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously");
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showAlert("Error", "Could not connect to the database. Please check your Firebase config and refresh the page.");
                }
            }

            // --- Firestore Collection Reference ---
            const studentCollection = collection(db, "students");

            // --- UI Elements ---
            const feeForm = document.getElementById('feeForm');
            const historyTableBody = document.getElementById('historyTableBody');
            const loader = document.getElementById('loader-container');
            const historyContainer = document.getElementById('history-table-container');
            const noRecordsMessage = document.getElementById('no-records');

            // --- PDF Generation ---
            const { jsPDF } = window.jspdf;
            
            function generatePDF(data) {
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                doc.text("Emmanuel School of Theology", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text("Fee Payment Receipt", doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

                // **FIX:** Use the client's current date for the PDF receipt.
                // The server timestamp is still saved accurately in the database.
                const date = new Date().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                doc.setFontSize(10);
                doc.text(`Date: ${date}`, 20, 45);

                doc.autoTable({
                    startY: 55,
                    head: [['Description', 'Details']],
                    body: [
                        ['Student Name', data.name],
                        ['Batch', data.batch],
                        ['Amount Paid', `$${Number(data.paid).toFixed(2)}`],
                        ['Amount Due', `$${Number(data.due).toFixed(2)}`],
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [30, 58, 138] },
                });

                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text('Thank you for your payment.', 20, doc.internal.pageSize.getHeight() - 10);
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() - 30, doc.internal.pageSize.getHeight() - 10);
                }
                
                doc.save(`Receipt-${data.name.replace(/\s/g, '_')}-${new Date().toISOString().slice(0,10)}.pdf`);
            }

            // --- Firestore Operations ---
            
            feeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const studentData = {
                    name: document.getElementById('studentName').value,
                    batch: document.getElementById('batch').value,
                    paid: document.getElementById('amountPaid').value,
                    due: document.getElementById('amountDue').value,
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(studentCollection, studentData);
                    // Now that we know it's saved, show the correct message and generate the PDF.
                    showAlert("Success!", "Record saved and PDF is being generated.");
                    generatePDF(studentData);
                    feeForm.reset();
                } catch (error) {
                    // This will now only catch true saving errors.
                    console.error("Error adding document: ", error);
                    showAlert("Error", "Failed to save the record. Please try again.");
                }
            });

            onSnapshot(studentCollection, (snapshot) => {
                loader.style.display = 'none';
                historyContainer.classList.remove('hidden');

                if (snapshot.empty) {
                    historyTableBody.innerHTML = '';
                    noRecordsMessage.classList.remove('hidden');
                    return;
                }

                noRecordsMessage.classList.add('hidden');
                let html = '';
                const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0));

                docs.forEach(docSnap => {
                    const student = docSnap.data();
                    const date = student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    html += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4">${date}</td>
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${student.name}</th>
                            <td class="px-6 py-4">${student.batch}</td>
                            <td class="px-6 py-4 text-green-600 font-medium">$${Number(student.paid).toFixed(2)}</td>
                            <td class="px-6 py-4 text-red-600 font-medium">$${Number(student.due).toFixed(2)}</td>
                            <td class="px-6 py-4">
                                <button data-id="${docSnap.id}" class="delete-btn font-medium text-red-600 hover:underline">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                historyTableBody.innerHTML = html;
            }, (error) => {
                console.error("Error fetching history:", error);
                loader.style.display = 'none';
                historyContainer.classList.add('hidden');
                noRecordsMessage.textContent = "Error loading data. Please check your connection.";
                noRecordsMessage.classList.remove('hidden');
            });

            historyTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    showConfirmModal(id);
                }
            });

            // --- Tab Switching Logic ---
            const tabs = document.querySelectorAll('[role="tab"]');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.setAttribute('aria-selected', 'false');
                        t.classList.remove('border-blue-600', 'text-blue-600');
                        t.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    });
                    tabContents.forEach(c => c.classList.remove('active'));

                    tab.setAttribute('aria-selected', 'true');
                    tab.classList.add('border-blue-600', 'text-blue-600');
                    tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    document.getElementById(tab.getAttribute('aria-controls')).classList.add('active');
                });
            });
            document.getElementById('home-tab').classList.add('border-blue-600', 'text-blue-600');
            document.getElementById('home-tab').classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');

            // --- Modal Logic ---
            const alertModal = document.getElementById('alertModal');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            const closeAlertModalBtn = document.getElementById('closeAlertModal');
            const confirmModal = document.getElementById('confirmModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
            }

            function showConfirmModal(id) {
                confirmModal.classList.remove('hidden');
                confirmDeleteBtn.dataset.id = id; // Store the id on the button
            }

            function hideConfirmModal() {
                confirmModal.classList.add('hidden');
            }

            closeAlertModalBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
            cancelDeleteBtn.addEventListener('click', hideConfirmModal);
            
            confirmDeleteBtn.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                try {
                    await deleteDoc(doc(db, "students", id));
                    hideConfirmModal();
                    showAlert("Deleted!", "The record has been successfully deleted.");
                } catch (error) {
                    hideConfirmModal();
                    console.error("Error deleting document: ", error);
                    showAlert("Error", "Failed to delete the record.");
                }
            });

            // --- Initial Load ---
            authenticate();
        }

        // Run the application
        startApp();

    </script>
</body>
</html>
